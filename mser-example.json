{"version":3,"kind":"Notebook","sha256":"e18f1d4703b0cff50347702404e16607fcee1a2cd67b9521f0d18d222b916145","slug":"mser-example","location":"/capitolo3/mser_example.ipynb","dependencies":[],"frontmatter":{"kernelspec":{"name":"python3","display_name":".venv (3.12.9)","language":"python"},"numbering":{"title":{"offset":1}},"exports":[{"format":"ipynb","filename":"mser_example.ipynb","url":"/elab_bioimmagini-site/build/mser_example-0216e1ee22eb92972a9abe996430acdb.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"# -*- coding: utf-8 -*-\n\"\"\"\nCreated on Mon Sep 16 15:11:20 2024\n\n@author: alejandro\n\"\"\"\n\nimport numpy as np\nimport matplotlib.pyplot as plt\nimport cv2\nimport pydicom\nfrom scipy.ndimage import label\nimport time\n\n# read file\ndb = pydicom.dcmread('../data/phantom.dcm')\nimage = db.pixel_array\n\nfig, ax = plt.subplots(1, 2)\nax[0].imshow(image, cmap = 'gray')\nax[1].plot(image[np.round(db.Rows/2).astype(int),:])\n\n# simplified MSER algorithm\npixel_list= np.sort(image.reshape(-1,1))\ntmp = np.zeros_like(image)\n\nG = np.unique(pixel_list)\n\nn_labels = np.zeros_like(G)\nlabels = np.zeros((len(G), *image.shape))\nfig, ax = plt.subplots(1,2)\nfor g in range(len(G)):\n    ax[0].cla()\n    ax[1].cla()\n    idx = np.where(image == G[g])\n    tmp[idx] = 1\n    l, num = label(tmp, structure=np.ones((3, 3))) \n    labels[g] = l\n    n_labels[g] = num\n    \n    ax[0].imshow(l)\n    ax[1].plot(np.arange(len(G)), np.log(n_labels +1))\n    # drawing updated values\n    fig.canvas.draw()\n    \n    # This will run the GUI event\n    # loop until all UI events\n    # currently waiting have been processed\n    fig.canvas.flush_events()\n\n    time.sleep(0.001)\n    \n    # show the figure\n    fig.show()\n    \n# follow background area\n# fig, ax = plt.subplots()\nmaps = np.zeros((len(G), *image.shape))\nareaBK = np.zeros(len(G))\n\nfor g in range(len(G)):\n    current_lab = np.squeeze(labels[g,:,:])\n    area = np.zeros(n_labels[g])\n    for n in range(n_labels[g]):\n        idx = np.where(current_lab == (n+1))\n        area[n] = len(idx[0])\n    idmax = np.argmax(area)\n    id1 = np.where(current_lab == (idmax+1))\n    areaBK[g] = len(id1[0])\n    maps[g][idx] = 255\n    \n    # ax.imshow(np.squeeze(maps[g,:,:]))\n    # # drawing updated values\n    # fig.canvas.draw()\n    # fig.canvas.flush_events()\n    # time.sleep(0.001)\n    \n    # fig.show()\n    \nfig, ax = plt.subplots(1, 2)\nax[0].plot(areaBK)\nvariazione = 50*np.diff(areaBK)\nax[1].plot(variazione)\n\nidx = np.where(variazione == 0)\n\n\nmser = cv2.MSER_create()\nregionsc= mser.detectRegions(cv2.cvtColor(image, cv2.COLOR_BGR2GRAY))\ndisplay()","key":"c8nYkLoa1x"},{"type":"outputs","id":"LNOzbUbajF3Sg82B09NgA","children":[{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/var/folders/f2/szdn4h555wv3xkj5npgb1nqc0000gn/T/ipykernel_4109/3500369035.py:54: UserWarning: FigureCanvasAgg is non-interactive, and thus cannot be shown\n  fig.show()\n"},"children":[],"key":"b2OOLo1Olq"},{"type":"output","jupyter_data":{"ename":"KeyboardInterrupt","evalue":"","output_type":"error","traceback":"\u001b[31m---------------------------------------------------------------------------\u001b[39m\n\u001b[31mKeyboardInterrupt\u001b[39m                         Traceback (most recent call last)\n\u001b[36mCell\u001b[39m\u001b[36m \u001b[39m\u001b[32mIn[5]\u001b[39m\u001b[32m, line 34\u001b[39m\n\u001b[32m     32\u001b[39m \u001b[38;5;28;01mfor\u001b[39;00m g \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mrange\u001b[39m(\u001b[38;5;28mlen\u001b[39m(G)):\n\u001b[32m     33\u001b[39m     ax[\u001b[32m0\u001b[39m].cla()\n\u001b[32m---> \u001b[39m\u001b[32m34\u001b[39m     \u001b[43max\u001b[49m\u001b[43m[\u001b[49m\u001b[32;43m1\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m.\u001b[49m\u001b[43mcla\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m     35\u001b[39m     idx = np.where(image == G[g])\n\u001b[32m     36\u001b[39m     tmp[idx] = \u001b[32m1\u001b[39m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/axes/_base.py:1461\u001b[39m, in \u001b[36m_AxesBase.cla\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m   1459\u001b[39m     \u001b[38;5;28mself\u001b[39m.__clear()\n\u001b[32m   1460\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m-> \u001b[39m\u001b[32m1461\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mclear\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/axes/_base.py:1452\u001b[39m, in \u001b[36m_AxesBase.clear\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m   1450\u001b[39m     \u001b[38;5;28mself\u001b[39m.cla()\n\u001b[32m   1451\u001b[39m \u001b[38;5;28;01melse\u001b[39;00m:\n\u001b[32m-> \u001b[39m\u001b[32m1452\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43m__clear\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/axes/_base.py:1330\u001b[39m, in \u001b[36m_AxesBase.__clear\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m   1327\u001b[39m yaxis_visible = \u001b[38;5;28mself\u001b[39m.yaxis.get_visible()\n\u001b[32m   1329\u001b[39m \u001b[38;5;28;01mfor\u001b[39;00m axis \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mself\u001b[39m._axis_map.values():\n\u001b[32m-> \u001b[39m\u001b[32m1330\u001b[39m     \u001b[43maxis\u001b[49m\u001b[43m.\u001b[49m\u001b[43mclear\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m  \u001b[38;5;66;03m# Also resets the scale to linear.\u001b[39;00m\n\u001b[32m   1331\u001b[39m \u001b[38;5;28;01mfor\u001b[39;00m spine \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mself\u001b[39m.spines.values():\n\u001b[32m   1332\u001b[39m     spine._clear()  \u001b[38;5;66;03m# Use _clear to not clear Axis again\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/axis.py:881\u001b[39m, in \u001b[36mAxis.clear\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    875\u001b[39m \u001b[38;5;28mself\u001b[39m._major_tick_kw[\u001b[33m'\u001b[39m\u001b[33mgridOn\u001b[39m\u001b[33m'\u001b[39m] = (\n\u001b[32m    876\u001b[39m         mpl.rcParams[\u001b[33m'\u001b[39m\u001b[33maxes.grid\u001b[39m\u001b[33m'\u001b[39m] \u001b[38;5;129;01mand\u001b[39;00m\n\u001b[32m    877\u001b[39m         mpl.rcParams[\u001b[33m'\u001b[39m\u001b[33maxes.grid.which\u001b[39m\u001b[33m'\u001b[39m] \u001b[38;5;129;01min\u001b[39;00m (\u001b[33m'\u001b[39m\u001b[33mboth\u001b[39m\u001b[33m'\u001b[39m, \u001b[33m'\u001b[39m\u001b[33mmajor\u001b[39m\u001b[33m'\u001b[39m))\n\u001b[32m    878\u001b[39m \u001b[38;5;28mself\u001b[39m._minor_tick_kw[\u001b[33m'\u001b[39m\u001b[33mgridOn\u001b[39m\u001b[33m'\u001b[39m] = (\n\u001b[32m    879\u001b[39m         mpl.rcParams[\u001b[33m'\u001b[39m\u001b[33maxes.grid\u001b[39m\u001b[33m'\u001b[39m] \u001b[38;5;129;01mand\u001b[39;00m\n\u001b[32m    880\u001b[39m         mpl.rcParams[\u001b[33m'\u001b[39m\u001b[33maxes.grid.which\u001b[39m\u001b[33m'\u001b[39m] \u001b[38;5;129;01min\u001b[39;00m (\u001b[33m'\u001b[39m\u001b[33mboth\u001b[39m\u001b[33m'\u001b[39m, \u001b[33m'\u001b[39m\u001b[33mminor\u001b[39m\u001b[33m'\u001b[39m))\n\u001b[32m--> \u001b[39m\u001b[32m881\u001b[39m \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mreset_ticks\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    883\u001b[39m \u001b[38;5;28mself\u001b[39m._converter = \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m    884\u001b[39m \u001b[38;5;28mself\u001b[39m._converter_is_explicit = \u001b[38;5;28;01mFalse\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/axis.py:904\u001b[39m, in \u001b[36mAxis.reset_ticks\u001b[39m\u001b[34m(self)\u001b[39m\n\u001b[32m    902\u001b[39m     \u001b[38;5;28;01mpass\u001b[39;00m\n\u001b[32m    903\u001b[39m \u001b[38;5;28;01mtry\u001b[39;00m:\n\u001b[32m--> \u001b[39m\u001b[32m904\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mset_clip_path\u001b[49m\u001b[43m(\u001b[49m\u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43maxes\u001b[49m\u001b[43m.\u001b[49m\u001b[43mpatch\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    905\u001b[39m \u001b[38;5;28;01mexcept\u001b[39;00m \u001b[38;5;167;01mAttributeError\u001b[39;00m:\n\u001b[32m    906\u001b[39m     \u001b[38;5;28;01mpass\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/axis.py:1118\u001b[39m, in \u001b[36mAxis.set_clip_path\u001b[39m\u001b[34m(self, path, transform)\u001b[39m\n\u001b[32m   1116\u001b[39m \u001b[38;5;28msuper\u001b[39m().set_clip_path(path, transform)\n\u001b[32m   1117\u001b[39m \u001b[38;5;28;01mfor\u001b[39;00m child \u001b[38;5;129;01min\u001b[39;00m \u001b[38;5;28mself\u001b[39m.majorTicks + \u001b[38;5;28mself\u001b[39m.minorTicks:\n\u001b[32m-> \u001b[39m\u001b[32m1118\u001b[39m     \u001b[43mchild\u001b[49m\u001b[43m.\u001b[49m\u001b[43mset_clip_path\u001b[49m\u001b[43m(\u001b[49m\u001b[43mpath\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mtransform\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m   1119\u001b[39m \u001b[38;5;28mself\u001b[39m.stale = \u001b[38;5;28;01mTrue\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/axis.py:237\u001b[39m, in \u001b[36mTick.set_clip_path\u001b[39m\u001b[34m(self, path, transform)\u001b[39m\n\u001b[32m    234\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34mset_clip_path\u001b[39m(\u001b[38;5;28mself\u001b[39m, path, transform=\u001b[38;5;28;01mNone\u001b[39;00m):\n\u001b[32m    235\u001b[39m     \u001b[38;5;66;03m# docstring inherited\u001b[39;00m\n\u001b[32m    236\u001b[39m     \u001b[38;5;28msuper\u001b[39m().set_clip_path(path, transform)\n\u001b[32m--> \u001b[39m\u001b[32m237\u001b[39m     \u001b[38;5;28;43mself\u001b[39;49m\u001b[43m.\u001b[49m\u001b[43mgridline\u001b[49m\u001b[43m.\u001b[49m\u001b[43mset_clip_path\u001b[49m\u001b[43m(\u001b[49m\u001b[43mpath\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43mtransform\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    238\u001b[39m     \u001b[38;5;28mself\u001b[39m.stale = \u001b[38;5;28;01mTrue\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/artist.py:814\u001b[39m, in \u001b[36mArtist.set_clip_path\u001b[39m\u001b[34m(self, path, transform)\u001b[39m\n\u001b[32m    812\u001b[39m \u001b[38;5;28;01mif\u001b[39;00m transform \u001b[38;5;129;01mis\u001b[39;00m \u001b[38;5;28;01mNone\u001b[39;00m:\n\u001b[32m    813\u001b[39m     \u001b[38;5;28;01mif\u001b[39;00m \u001b[38;5;28misinstance\u001b[39m(path, Rectangle):\n\u001b[32m--> \u001b[39m\u001b[32m814\u001b[39m         \u001b[38;5;28mself\u001b[39m.clipbox = TransformedBbox(\u001b[43mBbox\u001b[49m\u001b[43m.\u001b[49m\u001b[43munit\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m,\n\u001b[32m    815\u001b[39m                                        path.get_transform())\n\u001b[32m    816\u001b[39m         \u001b[38;5;28mself\u001b[39m._clippath = \u001b[38;5;28;01mNone\u001b[39;00m\n\u001b[32m    817\u001b[39m         success = \u001b[38;5;28;01mTrue\u001b[39;00m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/transforms.py:789\u001b[39m, in \u001b[36mBbox.unit\u001b[39m\u001b[34m()\u001b[39m\n\u001b[32m    786\u001b[39m \u001b[38;5;129m@staticmethod\u001b[39m\n\u001b[32m    787\u001b[39m \u001b[38;5;28;01mdef\u001b[39;00m\u001b[38;5;250m \u001b[39m\u001b[34munit\u001b[39m():\n\u001b[32m    788\u001b[39m \u001b[38;5;250m    \u001b[39m\u001b[33;03m\"\"\"Create a new unit `Bbox` from (0, 0) to (1, 1).\"\"\"\u001b[39;00m\n\u001b[32m--> \u001b[39m\u001b[32m789\u001b[39m     \u001b[38;5;28;01mreturn\u001b[39;00m \u001b[43mBbox\u001b[49m\u001b[43m(\u001b[49m\u001b[43m[\u001b[49m\u001b[43m[\u001b[49m\u001b[32;43m0\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[32;43m0\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[43m[\u001b[49m\u001b[32;43m1\u001b[39;49m\u001b[43m,\u001b[49m\u001b[43m \u001b[49m\u001b[32;43m1\u001b[39;49m\u001b[43m]\u001b[49m\u001b[43m]\u001b[49m\u001b[43m)\u001b[49m\n\n\u001b[36mFile \u001b[39m\u001b[32m~/Desktop/elab_bioimmagini/.venv/lib/python3.12/site-packages/matplotlib/transforms.py:763\u001b[39m, in \u001b[36mBbox.__init__\u001b[39m\u001b[34m(self, points, **kwargs)\u001b[39m\n\u001b[32m    760\u001b[39m     \u001b[38;5;28;01mraise\u001b[39;00m \u001b[38;5;167;01mValueError\u001b[39;00m(\u001b[33m'\u001b[39m\u001b[33mBbox points must be of the form \u001b[39m\u001b[33m'\u001b[39m\n\u001b[32m    761\u001b[39m                      \u001b[33m'\u001b[39m\u001b[33m\"\u001b[39m\u001b[33m[[x0, y0], [x1, y1]]\u001b[39m\u001b[33m\"\u001b[39m\u001b[33m.\u001b[39m\u001b[33m'\u001b[39m)\n\u001b[32m    762\u001b[39m \u001b[38;5;28mself\u001b[39m._points = points\n\u001b[32m--> \u001b[39m\u001b[32m763\u001b[39m \u001b[38;5;28mself\u001b[39m._minpos = \u001b[43m_default_minpos\u001b[49m\u001b[43m.\u001b[49m\u001b[43mcopy\u001b[49m\u001b[43m(\u001b[49m\u001b[43m)\u001b[49m\n\u001b[32m    764\u001b[39m \u001b[38;5;28mself\u001b[39m._ignore = \u001b[38;5;28;01mTrue\u001b[39;00m\n\u001b[32m    765\u001b[39m \u001b[38;5;66;03m# it is helpful in some contexts to know if the bbox is a\u001b[39;00m\n\u001b[32m    766\u001b[39m \u001b[38;5;66;03m# default or has been mutated; we store the orig points to\u001b[39;00m\n\u001b[32m    767\u001b[39m \u001b[38;5;66;03m# support the mutated methods\u001b[39;00m\n\n\u001b[31mKeyboardInterrupt\u001b[39m: "},"children":[],"key":"I0ROHC1roO"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"2ab67c7aa892e220dc2e131a1154dda4","path":"/elab_bioimmagini-site/build/2ab67c7aa892e220dc2e131a1154dda4.png"},"text/plain":{"content":"<Figure size 640x480 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"cJrSnXTRh1"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"e6c2fd93d435c8baa7ab6f73d48281c7","path":"/elab_bioimmagini-site/build/e6c2fd93d435c8baa7ab6f73d48281c7.png"},"text/plain":{"content":"<Figure size 640x480 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"bPomZ05Bn8"}],"key":"lgcEiyDU24"}],"key":"Bgf5YgNQ3K"}],"key":"eVy199Zgzt"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Hierarchical Clustering Example","url":"/hierarchical-clustering-example","group":"Capitolo3"},"next":{"title":"Seg Contorni","url":"/seg-contorni","group":"Capitolo3"}}},"domain":"http://localhost:3000"}