# Esercitazione 3: segmentazione su immagini di perfusione cardiaca

## Contesto clinico

L’oggetto dell’esercitazione è una serie di immagini 2D+T che descrive la diffusione del mezzo di contrasto (Gadolinio) a livello cardiaco dopo la somministrazione dello stesso (first-pass perfusion). Lo scopo di questa tecnica di imaging MR è verificare la corretta perfusione del miocardio da parte delle tre arterie coronariche. Se le coronarie non presentano stenosi, il mezzo di contrasto iniettato al paziente come bolo compatto passerà nelle tre coronarie e perfonderà il miocardio in modo omogeneo. Se una coronaria presenta una stenosi, il passaggio del mezzo di contrasto sarà rallentato e si noterà un difetto di perfusione nella regione di miocardio corrispondente alla coronaria interessata. In Figura 3.52 è riportata un'immagine di perfusione cardiaca in cui si osserva un difetto nella perfusione dei segmenti infero-settale e inferiore, corrispondenti alla coronaria destra (RCA) come definite dal modello AHA. Il modello AHA è usato come riferimento per la refertazione del miocardio, i tra anelli, dall’interno verso l’esterno, corrispondono alla regione apicale, media e basale del ventricolo sinistro. I settori ai segmenti cardiaci.
                      
<img src="./images/image-52.png" alt="perf-aha" style="width:100%;">

*Figura 3.52. Immagine di perfusione cardiaca MRI e modello AHA.*

Non essendo predicibile la dinamica del contrasto nel singolo paziente, si inietta un bolo di contrasto e si iniziano ad acquisire le immagini fino al passaggio completo del bolo. Lo schema di acquisizione è illustrato in Figura 3.53 (Gerber et al JCMR 2008). L’acquisizione è sincronizzata con l’ECG del paziente. Per 
ogni fetta in asse corto acquisita la sequenza prevede un impulso di saturazione (PREP) ed una procedura veloce di imaging (GRE) in modo da ottenere una immagine T1 pesata che massimizzi il contrasto tra il gadolinio ed il miocardio. Nella configurazione in figura vengono acquisite sei fette, tre per ogni intervallo RR. In questo caso l’intervallo di campionamento è 2RR.

<img src="./images/image-53.png" alt="acquisizione" style="width:100%;">

*Figura 3.53. Schema di acquisizione per immagini di perfusione cardiaca.*

Nei dati dell’esercitazione si è scelto di acquisire tre fette, basale, media ed apicale, per ottenere una refertazione secondo il modello AHA, accorciando l’intervallo di campionamento a RR. Le immagini sono acquisite in fase diastolica, una per ogni battito cardiaco, quindi l’intervallo di campionamento temporale è pari alla durata di un ciclo cardiaco. Il valore del tempo di acquisizione è contenuto nel campo TriggerTime del DICOM.

Come si osserva dalla Figura 3.54 (che mostra un crop dell’immagine originale centrato sul cuore) il contrasto appare nel ventricolo destro, poi nel sinistro ed infine nel miocardio. Il segnale sugli altri tessuti non viene sostanzialmente influenzato in quanto osserviamo solo il primo passaggio del contrasto. L’acquisizione nel caso di figura dura 80 cicli cardiaci, quindi 1 minuto/1 minuto e mezzo in dipendenza dalla frequenza cardiaca del paziente. L’acquisizione viene effettuata a “respiro trattenuto” per evitare i movimenti respiratori che disallineerebbero le immagini. Spesso il paziente non può trattenere il respiro per un tempo così lungo per cui in fase di elaborazione si utilizzano algoritmi per la registrazione di immagini per correggere il problema. In questo caso possiamo considerare le immagini registrate.

<img src="./images/image-54.png" alt="mosaico" style="width:100%;">

*Figura 3.54. Serie di immagini da perfusione cardiaca.*

Essendo le immagini di tipo 2D+T, ogni pixel dell’immagine corrisponderà ad una locazione spaziale per la quale sono disponibili $N$ ($N=80$ nel nostro esempio) misure del valore di segnale. Nell’analisi quantitativa delle immagini di perfusione si procede nel modo seguente:

1.	Sulla prima delle tre fette, si definisce il miocardio attraverso il suo contorno interno (endocardio) ed esterno (epicardio). 

<img src="./images/image-55.png" alt="segm" style="width:100%;">

*Figura 3.55. Definizione del contorno del miocardio.*

2.	Si propaga il contorno su tutti i frame temporali, identificando il miocardio su tutti i frame visto che tutte le immagini sono in fase diastolica (Figura 3.56). Se è presente il movimento respiratorio del paziente le immagini dovranno essere riallineate attraverso un algoritmo di registrazione. 

<img src="./images/image-56.png" alt="segm-mosaico" style="width:100%;">

*Figura 3.56. Estensione del contorno del miocardio a tutto il volume di acquisizione.*

Si divide il miocardio in sei segmenti (o quattro nella fetta apicale) seguendo il modello AHA (Figura 3.57). 

<img src="./images/image-57.png" alt="segm-mosaico" style="width:100%;">

*Figura 3.57. Divisione del miocardio in 6 segmenti.*

Il programma calcola la media del segnale su un segmento per tutti i frame temporali, ottenendo sei curve di perfusione, una per ogni segmento. Inoltre da una regione posta al centro dell’endocardio viene estratta la curva di segnale del sangue nel ventricolo sinistro.

<img src="./images/image-58.png" alt="media-t" style="width:100%;">

*Figura 3.58. Media del segnale per i diversi frame temporali.*

Dalle curve viene estratta la cosiddetta up-slope, cioè la massima pendenza della curva. Si ottiene facendo scorrere sulla curva una finestra ( ad esempio di 5 punti) e calcolando la pendenza della retta che fitta la curva sulla finestra (Figura 3.59). 

<img src="./images/image-59.png" alt="up-slope" style="width:100%;">

*Figura 3.59. Stima della up-slope.*

Il massimo valore della up-slope rappresenta la massima crescita del segnale sul miocardio e caratterizza la curva di perfusione. Per diminuire la dipendenza dalla modalità di iniezione del contrasto si utilizza in realtà la up-slope normalizzata pari a $100*upslope_{miocardio}/upslope_{sangue}$.

Si ripete l’analisi sulle altre due fette e si ottiene il modello AHA a 16 segmenti della perfusione miocardica (Figura 3.60).

<img src="./images/image-60.png" alt="aha" style="width:100%;">

*Figura 3.60. Modello AHA a 16 segmenti.*
    
Un punto debole della procedura prima descritta è il tracciamento manuale del miocardio che implica una variabilità indotta dall’operatore e una perdita di tempo. Lo scopo dell’esercitazione è sviluppare una procedura automatica di segmentazione del miocardio, del ventricolo sinistro e del ventricolo destro attraverso l’algoritmo di clustering esclusivo *k-means*.

## Esercitazione
Lo scopo dell’esercitazione è segmentare una sequenza 2D+T di perfusione miocardica attraverso l’algoritmo *k-means*. L’algoritmo *k-means* può incontrare il problema dello svuotamento di un cluster, soprattutto se un cluster è “piccolo” rispetto alle dimensioni complessive dell’immagine. Per questo motivo e per velocizzare l’algoritmo può essere quindi opportuno effettuare un “crop” dell’immagine in modo da isolare la zona di interesse.

Come detto in precedenza, ogni pixel dell’immagine è caratterizzato dalla propria curva intensità/tempo, come in figura (RV, blu; LV, rosso; miocardio, verde). Le altre regioni avranno un segnale costante a meno del rumore non essendo interessate dal contrasto. L’algoritmo kmeans classificherà i pixel dell’immagine in base alla “distanza” tra le curve relative ai pixel.
 
Se si usa una distanza classica di tipo geometrico ('sqEuclidean' o 'cityblock') il valore della distanza tra due curve sarà la somma delle differenze su tutti i campioni temporali (frame). Essendo gli ultimi frame molto simili tra loro, per esaltare la differenza tra le curve può essere preferibile usare un numero di frame temporali minore di quello a disposizione, cioè definire una finestra temporale in cui effettuare la segmentazione. 

Una alternativa è utilizzare una distanza di tipo correlativo. In python questo è possibile andando a definire le distanze correlative tramite il comando 
```python
correlation_distances = squareform(pdist(data, metric='correlation'))
``` 
e usarlo come input alla classe `Kmeans`.

Opzioni di interesse della classe `Kmeans` sono ‘n_init’ (ripete il clustering $N$ volte e ritorna il risultato migliore). Notiamo infine che l’algoritmo *k-means* in generale restituisce i cluster ordinati in modo casuale, quindi sarà necessario identificare a posteriori i quattro tessuti di interesse.

L’esercitazione richiede:
1. Utilizzare l’algoritmo *k-means* per effettuare la segmentazione del ventricolo destro, ventricolo sinistro e miocardio (numero di cluster = 4). Si determini il numero di frames da utilizzare ed il tipo di distanza che ottimizza la segmentazione (geometrica o correlativa).
2. Per valutare la qualità della segmentazione si utilizzi lo Jaccard index definito tra la maschera ottenuta dalla segmentazione e la maschera presa come “ground truth”:

$$
J(A,B) = \frac{|A \cap B|}{|A \cup B|}
$$

Lo jaccard index misura il livello di sovrapposizione percentuale tra due maschere, un valore uno indica la perfetta sovrapposizione. Le maschere di riferimento sono nel file “GroundTruth.mat”. Se è stato effettuato un cropping dell’immagine originale, lo stesso cropping dovrà essere applicato alla maschera GT. Per ottimizzare il risultato della segmentazione è possibile utilizzare un algoritmo di tipo labeling per eliminare le regioni spurie.
