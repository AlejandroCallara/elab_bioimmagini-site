# Esercitazione 4: stima della rigidità arteriosa

## Contesto clinico
Negli ultimi anni, è stata posta grande enfasi sul ruolo della rigidità arteriosa (stiffnes) nello sviluppo della malattia cardiovascolare (http://www.sisa.it/upload/GIA_2010_n0_3.pdf). Le grandi arterie elastiche, come l’aorta e la carotide, rivestono due fondamentali funzioni fisiologiche. Da un lato consentono la conduzione del sangue dal cuore alle arterie periferiche, dall’altro permettono la trasformazione di un flusso pulsatile, generato dall’azione cardiaca, in uno continuo, proprio dei tessuti periferici. L’incremento della rigidità dei grandi vasi comporta una serie di conseguenze fisiologiche, tanto che numerosi studi clinici hanno documentato il significato prognostico indipendente della rigidità aortica nei confronti della morbilità e mortalità cardiovascolare. L’età rappresenta il principale determinante della stiffness arteriosa. Con l’età e con il ripetersi di cicli di stress, le fibre elastiche vanno incontro a fratturazione e frammentazione, con conseguente dilatazione del vaso ed irrigidimento della parete. Il progressivo irrigidimento dell’aorta comporta almeno due conseguenze emodinamiche sfavorevoli: 
1. l’aumento della velocità sia dell’onda incidente che di quella riflessa fa sì che l’onda riflessa si fonda con quella incidente più precocemente, ossia già nella prima della parte della sistole, invece che alla fine della sistole. Ciò aumenta la pressione sistolica aortica (con conseguente aumento del post-carico cardiaco) e riduce la pressione diastolica (che riduce il flusso ematico miocardico, che avviene quasi esclusivamente in diastole), favorendo l’evoluzione verso l’ischemia miocardica e l’insufficienza cardiaca; 
2. l’aumento della stiffness è molto più marcato nelle arterie elastiche (aorta e carotidi) che nelle arterie muscolari (più periferiche). Succede così che con l’età la stiffness aortica raggiunga e superi quella periferica, riducendo così o addirittura invertendo il normale gradiente di stiffness centro-periferia che è il principale responsabile della riflessione dell’onda sfigmica. Ciò fa sì che il sito di riflessione dell’onda si sposti con l’età più distalmente e che l’entità dell’onda riflessa si riduca. Tutto ciò aumenta la trasmissione in periferia di un’ampia onda incidente, che espone arterie ed arteriole periferiche a livelli dannosi di pulsatilità pressoria e può contribuire all’ampio spettro di alterazioni microvascolari che si osservano comunemente nell’anziano specialmente negli organi ad alto flusso e bassa resistenza come l’encefalo ed i reni. 

Per questo motivo, la valutazione della rigidità arteriosa è stata sempre più introdotta nella pratica clinica. La rigidità arteriosa locale si definisce come la pressione necessaria per ottenere una determinata dilatazione in un segmento arterioso. Questa definizione fa già intuire le limitazioni insite nella sua misurazione: per una misurazione diretta della rigidità è infatti necessario misurare contemporaneamente, in maniera accurata e nello stesso segmento arterioso, l’andamento istantaneo della pressione e del calibro. Ciò è ottenibile solo con metodiche invasive, attraverso un accesso intra-arterioso e l’uso contemporaneo di trasduttori di pressione e di sensori di flusso. 

È possibile però stimare la rigidità di un vaso o dell’intero sistema arterioso in maniera non invasiva, senza quindi conoscere i valori istantanei di pressione e di volume di un dato segmento arterioso. Sono stati proposti vari metodi che implicano diversi metodi di misurazione. La maggior parte dei metodi di misura si basa sulla misura della velocità dell’onda sfigmica o di polso (pulse wave velocity, PWV). Con l’aumento della rigidità del vaso aumenta la velocità di trasmissione dell’onda sfigmica. Questa relazione è stata teorizzata per la prima volta nel 1878 da due scienziati olandesi, Moens e Korteweg: velocità dell’onda sfigmica.

$$ 
PWV = \sqrt{\frac{Eh}{\rho D}}
$$

nella quale $E$ è il modulo elastico di una data arteria ovvero la sua rigidità, $h$ lo spessore della parete arteriosa, $\rho$ la densità del sangue e $D$ il diametro dell’arteria in diastole, ed è stata quindi sviluppata nel 1922 da Bramwell e dal premio Nobel Hill. Da questa relazione si evince che la $PWV$ ha una relazione diretta quadratica con il modulo elastico, ossia con la rigidità intrinseca di un vaso arterioso. $\rho$ è nota o può essere misurata con un prelievo sanguigno, $D$ e h possono essere misurati con una metodica di imaging, come nel caso dell’ecografia in figura ($h=IMT+EMT$) dove $IMT$ (Intima-media thickness) è lo spessore della parte interna (indice diagnostico legato alla presenza di arteriosclerosi) e $EMT$ (external-media thickness) è lo spessore della parete esterna. Nota la $PWV$ è quindi possibile stimare $E$.

<img src="./images/image-61.png" alt="emt-imt" style="width:100%;">

*Figura 3.61.  EMT e IMT.*

La $PWV$ viene valutata misurando il tempo che l’onda sfigmica impiega a percorrere una data distanza. I fattori critici in questo calcolo sono la misurazione precisa del tempo di transito e della distanza percorsa. 

L’onda sfigmica può essere registrata con metodiche differenti: tonometrica, piezoelettrica, Doppler, impedenziometrica. La tecnica più frequentemente usata è quella tonometrica. La tonometria ad applanazione è una tecnica semplice e riproducibile di analisi dell’onda sfigmica, che consiste nella lieve compressione (applanazione) di un’arteria superficiale contro il piano osseo sottostante per mezzo di un sensore pressorio (tonometro). La forma d’onda ottenuta con un tonometro ad alta fedeltà è virtualmente identica a quella registrata con un trasduttore intraarterioso. Qualunque sia la metodica utilizzata per ottenere il segnale, ai fini della misurazione della $PWV$ viene registrata l’onda di polso in due punti differenti dell’albero arterioso e viene calcolato l’intervallo temporale che intercorre tra il piede dell’onda nel punto prossimale e nel punto distale (utilizzando come comune repere l’onda R dell’ECG).

## Esercitazione
Nell’esercitazione ci proponiamo di stimare i valori di $D$ (diametro aorta in diastole) ed $h$ (spessore della parete del vaso) da immagini ecografiche della carotide. 

Le immagini sono state ottenute dal sito del software CAROLAB (https://www.creatis.insa-lyon.fr/carolab/). Si tratta di immagini 2D+T acquisite durante il ciclo cardiaco. 

Le immagini sono fornite in formato DICOM (CAROLAB_SAMPLE_DICOM.dcm) (Figura 3.62). Si tratta di un file DICOM in formato multi-slice, quindi un file unico che contiene più frame temporali. I dati essendo del tipo 2D+T possono essere visualizzati con il viewer `napari`.

<img src="./images/image-62.png" alt="emt-imt" style="width:100%;">

*Figura 3.62.  Frame del dataset a disposizione.*

Come avviene comunemente nei dati US, il file DICOM contiene sostanzialmente un salvataggio della schermata che appare sull’ecografo. Oltre all’immagine sono quindi presenti annotazioni e regioni di zero-padding. L’immagine è sostanzialmente un mosaico di regioni, che sono elencate nel campo DICOM *SequenceOfUltrasoundRegions*. Nel nostro caso ci sono due regioni, *Item_1* e *Item_2*. L’immagine che ci interessa è *Item_1* che può essere estratta dall’immagine globale con una operazione di crop attraverso i campi *RegionLocationMin/Max*. Essendo l’immagine un salvataggio dello schermo, non è presente nel DICOM il campo *pixel_spacing*. Per conoscere la dimensione del pixel dobbiamo utilizzare i campi all’interno di *Item_1*. In particolare, i campi *PhysicalDeltaX* e *PhysicalDeltaY* contengono la dimensione del pixel in cm. Trattandosi di un formato multi-slice, il tempo di acquisizione è contenuto nel campo DICOM *FrameTimeVector*, che è un vettore contenente l’intervallo temporale tra un frame temporale ed il precedente. Per convenzione il primo frame ha valore zero. La sequenza temporale non è sincronizzata con l’ECG e contiene 4-5 cicli cardiaci.

Per la segmentazione del vaso si può utilizzare un approccio a *Contorni Attivi* (snakes),
implementato in MATLAB dalla funzione `activecontour`.
La funzione `activecontour` implementa due differenti approcci, quello *Chan–Vese*
(opzione di default) e quello *edge*, che realizza il classico approccio di tipo *Snake*.
L’approccio *Chan–Vese* rappresenta una versione ottimizzata dal punto di vista del tempo
di convergenza e dell’accuratezza. In Python, approcci equivalenti sono disponibili nella libreria **scikit-image**.
In particolare, l’algoritmo di *Chan–Vese* è implementato tramite la funzione
`skimage.segmentation.chan_vese` (e la relativa variante
`skimage.segmentation.morphological_chan_vese`), mentre l’approccio basato sui bordi
(*edge-based snake*) è implementato tramite la funzione
`skimage.segmentation.active_contour`.

La segmentazione a contorni utilizza contorni chiusi, mentre la carotide nella visualizzazione a disposizione è “aperta” sui due lati confinando con due regioni di zero-padding. Essendo noto il valore di tali regioni è possibile imporre in esse un valore arbitrario per ottimizzare la segmentazione.

I parametri della di una funziona a contorni attivi sono generalmente:
1. L’immagine da segmentare A
2. Il contorno di partenza (seed), che viene definito come la maschera interna al contorno. Le due rappresentazioni sono infatti equivalenti.
3. Il numero $n$ di iterazioni dello snake.

L’uscita della funzione è la maschera del contorno risultante che definirà l’area della carotide in pixel. L’area reale andrà calcolata tenendo conto della dimensione del pixel stesso estratta dai campi DICOM. 

I parametri che definiscono il comportamento dello snake sono:
1. `ContractionBias` ($\alpha$), che definisce la tendenza dello snake ad espandersi o contrarsi. In questa implementazione, valori negativi favoriscono l’espansione dello snake, mentre valori positivi ne favoriscono la contrazione.
2. `SmoothFactor` ($\beta$), che definisce la regolarità dello snake; valori più elevati producono contorni più lisci e regolari.

In Python, nel caso dell’algoritmo di Chan–Vese implementato dalla funzione
`skimage.segmentation.morphological_chan_vese`, i parametri `lambda1` e `lambda2`
controllano il peso dei termini di omogeneità delle regioni interna ed esterna al contorno.
Sebbene tali parametri non siano direttamente equivalenti a `ContractionBias` e
`SmoothFactor`, essi consentono di ottenere comportamenti qualitativamente simili
in termini di evoluzione e regolarità della segmentazione.

Dovendo elaborare una serie di immagini, per ogni immagine bisognerà identificare un seed. Per minimizzare l’interazione con l’utente è opportuno definire il seed su un singolo frame temporale ed utilizzare lo stesso seed su tutte le fasi, oppure utilizzare come seed di una fase il contorno calcolato alla fase precedente. È anche possibile adattare i parametri dello snake in base alla fase da segmentare. 

La ROI iniziale può essere definita in MATLAB con funzioni dedicate come `getpts`, seguita da
`poly2mask` per trasformare la ROI in una maschera, oppure mediante le funzioni più evolute
del toolbox *ROI-Based Processing*. In Python, una procedura analoga può essere realizzata definendo interattivamente i punti
della ROI tramite strumenti di visualizzazione. In particolare, la funzione
`plt.ginput` di **matplotlib** consente di selezionare manualmente con il mouse i vertici
di una ROI poligonale, che può poi essere convertita in una maschera binaria tramite la
funzione `skimage.draw.polygon2mask` della libreria **scikit-image**. In alternativa,
librerie come **napari** offrono strumenti più avanzati per la definizione interattiva
delle ROI.

Per controllare la bontà della segmentazione, in MATLAB si può utilizzare la funzione
`imshowpair`, che consente di visualizzare la maschera sovrapposta all’immagine a falsi colori
(dopo normalizzazione a 8 bit). In Python, una visualizzazione equivalente può essere ottenuta
sovrapponendo la maschera all’immagine tramite **matplotlib**, ad esempio utilizzando
`ax.imshow` per l’immagine e `ax.contour` per visualizzare il contorno della maschera.
Questa modalità riproduce il comportamento della funzione `visboundaries` di MATLAB.


Una volta noto il contorno del lume della carotide è possibile stimare il diametro della stessa modellando il vaso (o un tratto del vaso) come un cilindro che abbia come sezione longitudinale l’area definita dal contorno. Comprendendo l’acquisizione più cicli cardiaci, per avere la variazione di diametro durante il ciclo sarà necessario isolare i cicli cardiaci completi presenti nell’acquisizione e computare la variazione del diametro per i detti cicli e quindi il valore minimo del diametro che è relativo alla fase diastolica. 

Per ottenere lo spessore del vaso si possono utilizzare come seed i contorni del lume ed implementare una nuovo algoritmo a contorni che trovi la parete, ottenendo lo spessore come differenza tra le due serie di contorni. La parete è sostanzialmente incomprimibile, quindi il suo spessore dovrebbe risultare costante lungo il ciclo. 

In definitiva il programma da sviluppare deve implementare i seguenti passi:
1. Caricare l’immagine DICOM multi-frame estraendo la sotto-immagine di interesse ed i dati di risoluzione geometrica e temporale. 
2. Permettere la definizione da parte dell’utente di un seed, cioè il contorno di partenza, solo sul primo frame. 
3. Attraverso la un approccio di segmentazione ai contorni calcolare la maschera del lume della carotide e la sua area in $mm^2$. 
4. Ripetere la procedura **3** per tutti i frame temporali. 
5. Stimare dall’area il diametro $D$ del lume della carotide e graficare il diametro rispetto al tempo del ciclo in $ms$. Ci si attende che il diametro della carotide vari in modo congruente al ciclo cardiaco ripetendo lo stesso andamento su tutti i cicli compresi nell’acquisizione. Calcolare quindi il diametro della carotide in fase diastolica (diametro minimo). 
6. Ripetere la procedura per lo spessore di parete stimando lo spessore come media durante il ciclo. 
7. Per i più volenterosi stimare la frequenza cardiaca del paziente. 

