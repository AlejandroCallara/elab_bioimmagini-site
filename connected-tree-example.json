{"version":3,"kind":"Notebook","sha256":"fa7675f0c3d933e8820920798f5565f507fe37b62b06ab47efe819c3b124ec69","slug":"connected-tree-example","location":"/capitolo3/connected_tree_example.ipynb","dependencies":[],"frontmatter":{"kernelspec":{"name":"python3","display_name":".venv (3.12.9)","language":"python"},"numbering":{"title":{"offset":1}},"exports":[{"format":"ipynb","filename":"connected_tree_example.ipynb","url":"/elab_bioimmagini-site/build/connected_tree_examp-44299c595edd1c64d534cd1fbe8706de.ipynb"}]},"widgets":{},"mdast":{"type":"root","children":[{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"import numpy as np\nimport pandas as pd\nimport matplotlib.pyplot as plt\nimport networkx as nx\n","key":"p56Snqb5Zi"},{"type":"outputs","id":"E4aPaBjB46MHzek03FQiO","children":[],"key":"BlGVJjZk5r"}],"key":"btLE8KoizQ"},{"type":"block","kind":"notebook-code","children":[{"type":"code","lang":"python","executable":true,"value":"\n# ----------------------------\n# 1) Build the 7x7 image + map\n# ----------------------------\nimage = np.ones((7, 7), dtype=int)  # background = 1\nmp = np.zeros((7, 7), dtype=int)    # pattern map\n\n# MATLAB is 1-based; Python is 0-based -> subtract 1 from indices\n\n# level 2 patterns\nimage[1:3, 3] = 2\nmp[1:3, 3] = 2\n\nimage[5, 3:6] = 2\nimage[4, 3] = 2\nmp[5, 3:6] = 3\nmp[4, 3] = 3\n\n# level 3 patterns\nimage[1:3, 1:3] = 3\nmp[1:3, 1:3] = 4\n\nimage[1:3, 4] = 3\nimage[3, 5] = 3\nmp[1:3, 4] = 5\nmp[3, 5] = 5\n\nimage[4, 1:3] = 3\nimage[5, 2] = 3\nmp[4, 1:3] = 6\nmp[5, 2] = 6\n\n# level 4 patterns\nimage[1:3, 5] = 4\nmp[1:3, 5] = 7\n\nimage[5, 1] = 4\nmp[5, 1] = 8\n\n# background pixels -> map = 1 (like MATLAB)\nmp[image == 1] = 1\n\n# visualize image + map\nfig, ax = plt.subplots(1, 2, figsize=(10, 4))\nax[0].imshow(image, cmap=\"gray\", interpolation=\"nearest\")\nax[0].set_title(\"image\")\nax[0].axis(\"image\")\n\nax[1].imshow(mp, cmap=\"jet\", interpolation=\"nearest\")\nax[1].set_title(\"map\")\nax[1].axis(\"equal\")\nplt.tight_layout()\nplt.show()\n\n# -----------------------------------------\n# 2) Build NodeTable (names, levels, pixels)\n# -----------------------------------------\nnames = [f\"c{i}\" for i in range(1, 9)]\nlevels = [1, 2, 2, 3, 3, 3, 4, 4]\n\n# MATLAB 'find' returns linear indices (column-major).\n# We'll store BOTH:\n# - MATLAB-style linear indices (1..49, col-major)\n# - Python linear indices (0..48, row-major), if you ever need them\ndef matlab_linear_indices(mask_2d: np.ndarray) -> np.ndarray:\n    # mask_2d is boolean shape (7,7)\n    r, c = np.where(mask_2d)\n    # MATLAB linear index (1-based), column-major:\n    return (r + 1) + (c) * mask_2d.shape[0]\n\npixels_matlab = []\nfor i in range(1, 9):\n    idx = matlab_linear_indices(mp == i).tolist()\n    pixels_matlab.append(idx)\n\nnode_table = pd.DataFrame({\n    \"Name\": names,\n    \"Level\": levels,\n    \"Pixels\": pixels_matlab\n})\nprint(\"\\nNodeTable:\")\nprint(node_table)\n\n# ----------------------------\n# 3) Build directed graph (A)\n# ----------------------------\nA = np.zeros((8, 8), dtype=int)\nA[0, 1] = 1  # c1->c2\nA[0, 2] = 1  # c1->c3\nA[1, 3] = 1  # c2->c4\nA[1, 4] = 1  # c2->c5\nA[4, 6] = 1  # c5->c7\nA[2, 5] = 1  # c3->c6\nA[5, 7] = 1  # c6->c8\n\nG = nx.DiGraph()\n\n# add nodes with attributes (like NodeTable)\nfor i in range(8):\n    G.add_node(i+1, Name=names[i], Level=levels[i], Pixels=pixels_matlab[i])  # node ids 1..8\n\n# add edges from adjacency matrix\nfor i in range(8):\n    for j in range(8):\n        if A[i, j] == 1:\n            G.add_edge(i+1, j+1)\n\n# plot graph\nplt.figure(figsize=(6, 4))\npos = nx.spring_layout(G, seed=1)\nnx.draw(G, pos, with_labels=True, node_size=1200, arrows=True)\nnx.draw_networkx_labels(G, pos, labels={n: G.nodes[n][\"Name\"] for n in G.nodes})\nplt.title(\"Connected tree (digraph)\")\nplt.tight_layout()\nplt.show()\n\n# ----------------------------\n# 4) DFS order + split branches\n# ----------------------------\nv = list(nx.dfs_preorder_nodes(G, source=1))  # like dfsearch(G,1)\nlev = np.array([G.nodes[n][\"Level\"] for n in v])\n\ndiff_lev = np.diff(lev)\nprint(\"\\n[v, level, diff(level)]\")\nprint(np.column_stack([v, lev, np.r_[diff_lev, 0]]))\n\n# find where the level drops (diff < 0), like MATLAB\ndrop_idx = np.where(diff_lev < 0)[0]\nprint(\"\\nIndices where diff(level) < 0:\", drop_idx)\n\n# In your MATLAB, you used v(2:id) and v(id+1:end).\n# Here we mirror that using the first drop.\nif len(drop_idx) == 0:\n    raise RuntimeError(\"No level drop found; cannot split into two main branches.\")\nid0 = drop_idx[0]  # index in diff -> split point in v\n\n# note: MATLAB starts from v(2), skipping root\nMpattern1 = v[1:id0+1]      # inclusive up to id0\nMpattern2 = v[id0+1:]       # rest\n\nprint(\"\\nMpattern1:\", Mpattern1, [G.nodes[n][\"Name\"] for n in Mpattern1])\nprint(\"Mpattern2:\", Mpattern2, [G.nodes[n][\"Name\"] for n in Mpattern2])\n\n# collect pixel lists (MATLAB-style linear indices)\nMp1_pixels = [p for n in Mpattern1 for p in G.nodes[n][\"Pixels\"]]\nMp2_pixels = [p for n in Mpattern2 for p in G.nodes[n][\"Pixels\"]]\n\n# ---------------------------------------\n# 5) Build map1: 1 for branch1, 2 for branch2\n# ---------------------------------------\nmap1 = np.zeros((7, 7), dtype=int)\n\ndef matlab_lin_to_rc(lin: int, nrows: int) -> tuple[int, int]:\n    # lin is 1-based column-major\n    lin0 = lin - 1\n    r = lin0 % nrows\n    c = lin0 // nrows\n    return r, c\n\nfor lin in Mp1_pixels:\n    r, c = matlab_lin_to_rc(lin, 7)\n    map1[r, c] = 1\n\nfor lin in Mp2_pixels:\n    r, c = matlab_lin_to_rc(lin, 7)\n    map1[r, c] = 2\n\nplt.figure(figsize=(4, 4))\nplt.imshow(map1, cmap=\"jet\", interpolation=\"nearest\")\nplt.title(\"map1 (branch1=1, branch2=2)\")\nplt.axis(\"equal\")\nplt.tight_layout()\nplt.show()\n\n# ----------------------------\n# 6) Shortest path 2 -> 7\n# ----------------------------\nTR_nodes = nx.shortest_path(G, source=2, target=7)\nprint(\"\\nShortest path 2 -> 7:\", TR_nodes, [G.nodes[n][\"Name\"] for n in TR_nodes])\n\nTR = G.subgraph(TR_nodes).copy()\n\nplt.figure(figsize=(6, 4))\npos2 = nx.spring_layout(TR, seed=1)\nnx.draw(TR, pos2, with_labels=True, node_size=1200, arrows=True)\nnx.draw_networkx_labels(TR, pos2, labels={n: G.nodes[n][\"Name\"] for n in TR.nodes})\nplt.title(\"TR (shortest path subgraph)\")\nplt.tight_layout()\nplt.show()\n","key":"Mm2A8wZaH1"},{"type":"outputs","id":"RtMwJKrTYOW6Sgxz3jJE4","children":[{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"83e33f58c7536524e9cfa89f31a63104","path":"/elab_bioimmagini-site/build/83e33f58c7536524e9cfa89f31a63104.png"},"text/plain":{"content":"<Figure size 1000x400 with 2 Axes>","content_type":"text/plain"}}},"children":[],"key":"sVu3mjxW1w"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\nNodeTable:\n  Name  Level                                             Pixels\n0   c1      1  [1, 8, 15, 22, 29, 36, 43, 2, 44, 3, 45, 4, 11...\n1   c2      2                                           [23, 24]\n2   c3      2                                   [26, 27, 34, 41]\n3   c4      3                                    [9, 16, 10, 17]\n4   c5      3                                       [30, 31, 39]\n5   c6      3                                       [12, 19, 20]\n6   c7      4                                           [37, 38]\n7   c8      4                                               [13]\n"},"children":[],"key":"FLuucUbTs6"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/var/folders/f2/szdn4h555wv3xkj5npgb1nqc0000gn/T/ipykernel_30853/3939194047.py:113: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.\n  plt.tight_layout()\n"},"children":[],"key":"Q2zfl1bS3o"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"107710907c2571dcf8c205b0d9dd47cd","path":"/elab_bioimmagini-site/build/107710907c2571dcf8c205b0d9dd47cd.png"},"text/plain":{"content":"<Figure size 600x400 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"vkyg5Yymzg"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\n[v, level, diff(level)]\n[[ 1  1  1]\n [ 2  2  1]\n [ 4  3  0]\n [ 5  3  1]\n [ 7  4 -2]\n [ 3  2  1]\n [ 6  3  1]\n [ 8  4  0]]\n\nIndices where diff(level) < 0: [4]\n\nMpattern1: [2, 4, 5, 7] ['c2', 'c4', 'c5', 'c7']\nMpattern2: [3, 6, 8] ['c3', 'c6', 'c8']\n"},"children":[],"key":"rqHvPDHawQ"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"48a89bddd2182ff620f8b0502c3c46ce","path":"/elab_bioimmagini-site/build/48a89bddd2182ff620f8b0502c3c46ce.png"},"text/plain":{"content":"<Figure size 400x400 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"gqcH6aor4x"},{"type":"output","jupyter_data":{"name":"stdout","output_type":"stream","text":"\nShortest path 2 -> 7: [2, 5, 7] ['c2', 'c5', 'c7']\n"},"children":[],"key":"nmbVC89les"},{"type":"output","jupyter_data":{"name":"stderr","output_type":"stream","text":"/var/folders/f2/szdn4h555wv3xkj5npgb1nqc0000gn/T/ipykernel_30853/3939194047.py:187: UserWarning: This figure includes Axes that are not compatible with tight_layout, so results might be incorrect.\n  plt.tight_layout()\n"},"children":[],"key":"xm1AKVm0vV"},{"type":"output","jupyter_data":{"output_type":"display_data","metadata":{},"data":{"image/png":{"content_type":"image/png","hash":"32c7205fd86ce254caad0afc5555deb3","path":"/elab_bioimmagini-site/build/32c7205fd86ce254caad0afc5555deb3.png"},"text/plain":{"content":"<Figure size 600x400 with 1 Axes>","content_type":"text/plain"}}},"children":[],"key":"a49bXnM2vU"}],"key":"NnmyCFrDtk"}],"key":"gvqOs0UPCu"}],"key":"vPt3PziwcE"},"references":{"cite":{"order":[],"data":{}}},"footer":{"navigation":{"prev":{"title":"Capitolo 3: Segmentazione dellâ€™immagine Biomedica","url":"/c31-segmentazione","group":"Capitolo3"},"next":{"title":"Esempio Em Gmm","url":"/esempio-em-gmm","group":"Capitolo3"}}},"domain":"http://localhost:3000"}